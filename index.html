<!DOCTYPE HTML>
<html>
<head>
    <title>Barnett Compiler</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="compiler.css" />
</head>
<body onload="init();">
    <h1>Christopher Barnett's Compiler Project</h1>
    <p>
        <em>Code Generation!</em>:
    </p>  
    <div>
        <textarea id="taSourceCode" cols="32" rows="18"></textarea>
        <br>
        <input type="button" id="btnCompile" value="Compile" onclick="btnCompile_click();"/>
        <br>
		<div id="outSelectDiv" style="display: none;">
			<select id="outSelect" onchange="output(this.value)">
			  <option value="lex">Lex Output</option>
			  <option value="parse">Parse Output</option>
			  <option value="cst">CST Output</option>
			  <option value="ast">AST Output</option>
			  <option value="symb">Symbol Table Output</option>
			  <option value="sa">Semantic Analysis Output</option>
			  <option value="cg">Code Generation Output</option>
			</select>
		</div>
        <textarea id="taOutput" cols="32" rows="18"></textarea>
    </div>
    <!-- Footer -->
    <p>
        <a href="http://validator.w3.org/check?uri=referer">
            <img src="images/w3cvalidhtml5.jpg" alt="Valid HTML5" width="88" height="31" />
        </a>
    </p>
    <!-- Client-side code down here, per the YSlow advice. 
    // (http://developer.yahoo.com/performance/rules.html#js_bottom) -->
    <script type="text/javascript" src="scripts/utils.js"></script>	
    <script type="text/javascript" src="scripts/lexer.js"></script>		
	<script type="text/javascript" src="scripts/parse.js"></script>
	<script type="text/javascript" src="scripts/tree.js"></script>
	<script type="text/javascript" src="scripts/ast.js"></script>
	<script type="text/javascript" src="scripts/symbolTable.js"></script>
	<script type="text/javascript" src="scripts/codeGen.js"></script>
    <script type="text/javascript">
    // Global variables
    var tokens = []; //Holds all the tokens generated by lex
    var tokenIndex = 0; // Keeps track of the tokens
    var currentToken = "";
    var errorCount = 0; // The total number of errors generated in anywhere
    var EOF = new tokenObj(0, "T_EOF", "$"); //A token for the end of file, added if used forgot it
	var cst; //A tree for the Concrete Syntax Tree
	var ast; //A tree for the Abstract Syntax Tree
	var symtab; // A tree for the Symbol Table
	var epsilon = new tokenObj(0, "Epsilon", "epsilon"); //A token for representing epsilons in the CST
	var uninit; //A string to store the output of uninitialized variables
	var unused; //A string to store the output of unused variables
	
	var lexOut;  //A string to hold the output of Lex
	var parseOut; //A string to hold the output of Parse
	var cstOut; //A string to hold the output of the CST
	var astOut; //A string to hold the output of the AST
	var symbtabOut; //A string to hold the output of the Symbol Table
	var saOut; //A string to hold the output of Semantic Analysis
	var cgOut; //A string to hold the output of Code Generation
	
	

    function init() {
        // Clear the message box.
        document.getElementById("taOutput").value = "";
        // Set the initial values for our globals.
        tokens = [];
        tokenIndex = 0;
        currentToken = ' ';
        errorCount = 0;    
		cst = new Tree();
		ast = new Tree();
		symtab = new Tree();
		uninit = "";
		unused = "";
		
		lexOut = "";
		parseOut = "";
		cstOut = "";
		astOut = "";
		symbtabOut = "";
		saOut = "";
		cgOut = "";
		//TESTING
		//testSymbolTable();
    }
    
    function btnCompile_click() {    
        // This is executed as a result of the user pressing the 
        // "compile" button between the two text areas, above.  
        // Note the <input> element's event handler: onclick="btnCompile_click();
        init();
		lex();
		document.getElementById("outSelectDiv").style.display = "block";
		tokenIndex = 0;
		//Test code to display lexer output
		for(var i = 0; i < tokens.length; i++){
			lexOut += tokens[i] + "\n";
			//putMessage(tokens[i]);
		}
		putMessage("\n");
		if(errorCount == 0){
			parse();
		} else {
			lexOut += "\nLex found " + errorCount + " error(s).";
			output("lex")
		}
		//Build Trees and Symbol Table, do Semantic Analysis
		if(errorCount == 0){
			cstOut = "CST\n" + cst.toString();
			//putMessage(cst.toString());
			makeAST();
			astOut = "AST\n" + ast.toString();
			//putMessage(ast.toString());
			symbolTable();
			output("sa");
		}
		//If Semantic Analysis is good
		if(errorCount == 0){
			//Display Symbol Table
			symbtabOut = "Symbol Table\n\nScope\tType\tId\tLnNum\n-------------------------------" + symtab.printSymbTab();
			//If there are uninitialized variables
			if(uninit !== ""){
				saOut += "--------------------------\nWarning: Uninitialized Variables Found\n";
				saOut += "Scope\tType\tId\tLnNum\n--------------------------\n" + uninit;
			}
			/*
			if(unused !== ""){
				putMessage("--------------------------\n");
				putMessage("Warning: Unused Variables Found\n");
				putMessage("Scope\tType\tId\tLnNum");
				putMessage("--------------------------");
				putMessage(unused);
			}
			*/
			codeGeneration();
			output("cg");
		}
    }
    
    function putMessage(msg) {
        document.getElementById("taOutput").value += msg + "\n";
    }
	
	function clearOutput() {
		document.getElementById("taOutput").value = "";
	}
	
	function output(value){
		clearOutput();
		switch(value){
			case "lex":
				document.getElementById("outSelect").selectedIndex = 0;
				putMessage(lexOut);
			break;
			case "parse":
				document.getElementById("outSelect").selectedIndex = 1;
				putMessage(parseOut);
			break;
			case "cst":
				document.getElementById("outSelect").selectedIndex = 2;
				putMessage(cstOut);
			break;
			case "ast":
				document.getElementById("outSelect").selectedIndex = 3;
				putMessage(astOut);
			break;
			case "symb":
				document.getElementById("outSelect").selectedIndex = 4;
				putMessage(symbtabOut);
			break;
			case "sa":
				document.getElementById("outSelect").selectedIndex = 5;
				putMessage(saOut);
			break;
			case "cg":
				document.getElementById("outSelect").selectedIndex = 6;
				putMessage(cgOut);
			break;
			default:
		}
	}
	
	//OBJECT CONSTRUCTORS--------------------------------------------------------------------
	/* --------  
   Token Object Constructor
   Params: 	lineNum:int  - the line number the token is on, 1 is the first line number
			type:String  - the type of token it is
			value:String - the actual token itself
			
   Methods: toString() - overrides default toString, prints the three values in one line.
   -------- */
function tokenObj(lineNumber, type, value){
	this.lineNumber = lineNumber;
	this.type = type;
	this.value = value;
	this.toString = function(){
		return "" + this.lineNumber + " " + this.type + " \"" + this.value + "\"";
	};
}
    </script>
</body>
</html>
